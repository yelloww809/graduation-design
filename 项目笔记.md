# 1. 背景


# 2. 数据集分析

## 2.1 数据集信息

1. **由官方提供的数据集介绍 [data_intro](assets/official-docs/data-intro.md) 可知：**
   1. 数据共7500条；
   2. 采样率可能取值为 5MHz / 20MHz / 30MHz / 40MHz / 50MHz / 80MHz；
   3. 采样时长可能取值为 20ms / 40ms / 60ms / 80ms / 100ms / 150ms；
   4. 一条数据中最少包含1个信号，最多包含8个信号，这些信号可能在时域和频域上存在重叠，也就是说存在信号之间的干扰；

2. **由 [决赛路演视频](https://www.bilibili.com/video/BV1zS2BB4EQ9/?share_source=copy_web&vd_source=0c1479399d156d8020ab4bd08b058c8a) 可知：** 

    | Class | 信号类型 | 工作模式 | 调制方式 | 带宽(MHz)              |
    | ----- | -------- | -------- | -------- | ---------------------- |
    | 0     | WiFi     | HT20     | QPSK     | 20.0                   |
    | 1     | WiFi     | HT20     | 16QAM    | 20.0                   |
    | 2     | WiFi     | HT20     | 64QAM    | 20.0                   |
    | 3     | WiFi     | HT40     | QPSK     | 20.0 / 40.0            |
    | 4     | WiFi     | HT40     | 16QAM    | 40.0                   |
    | 5     | WiFi     | HT40     | 64QAM    | 40.0                   |
    | 6     | BLE      | LE       | GFSK     | 1.0                    |
    | 7     | BLE      | LE       | GFSK     | 2.0                    |
    | 8     | ZigBee   | standard | OQPSK    | 2.0                    |
    | 9     | LoRa     | standard | CSS      | 0.0523 / 0.0625 / 0.25 |
    | 10    | custom   | /        | QPSK     | 0.3 / 0.5 / 10.0       |
    | 11    | custom   | /        | 16QAM    | 1.6 / 7.56 / 10.0      |
    | 12    | custom   | /        | AM       | 0.006 / 0.2            |
    | 13    | custom   | /        | FM       | 0.04 / 0.12 / 0.2      |

3. **通过 python 脚本对数据集进行分析，可知：**
    1. **各种采样率的样本的个数:**
       | 采样率(Ms/s) | 数量(个) |
       | ------------ | -------- |
       | 5            | 1260     |
       | 20           | 1485     |
       | 30           | 1506     |
       | 40           | 1063     |
       | 50           | 1192     |
       | 80           | 994      |
    2. **各种采样时间的样本的个数:**
       | 采样时间(ms) | 数量(个) |
       | ------------ | -------- |
       | < 20         | 189      |
       | 20           | 3145     |
       | 40           | 824      |
       | 40<  <60     | 1        |
       | 60           | 798      |
       | 60<  <80     | 4        |
       | 80           | 831      |
       | 80<  <100    | 10       |
       | 100          | 813      |
       | 100<  <150   | 14       |
       | 150          | 871      |
    3. **单个样本中信号个数:**
       | 信号个数 | 数量 |
       | -------- | ---- |
       | 1        | 802  |
       | 2        | 767  |
       | 3        | 871  |
       | 4        | 1700 |
       | 6        | 1675 |
       | 8        | 1685 |
    4. **单个样本中信号种类数:**
       | 信号种类数 | 数量 |
       | ---------- | ---- |
       | 1          | 922  |
       | 2          | 1124 |
       | 3          | 1556 |
       | 4          | 1572 |
       | 5          | 1238 |
       | 6          | 810  |
       | 7          | 244  |
       | 8          | 34   |
    5. **各种信号的信息：**
       | Class | 总数量 | 占用带宽(MHz) : 个数                       |
       | ----- | ------ | ------------------------------------------ |
       | 0     | 1645   | 20 : 1645                                  |
       | 1     | 1596   | 20 : 1596                                  |
       | 2     | 1653   | 20 : 1653                                  |
       | 3     | 693    | 20 : 346 / 40 : 347                        |
       | 4     | 709    | 40 : 709                                   |
       | 5     | 701    | 40 : 701                                   |
       | 6     | 3580   | 1 : 3580                                   |
       | 7     | 3484   | 2 : 3484                                   |
       | 8     | 7035   | 2 : 7035                                   |
       | 9     | 7186   | 0.0523 : 2689 / 0.0625 : 915 / 0.25 : 3582 |
       | 10    | 1748   | 0.3 : 289 / 0.5 : 273 / 10 : 1186          |
       | 11    | 1769   | 1.6 : 293 / 7.56 : 290 / 10 : 1186         |
       | 12    | 1783   | 0.006 : 574 / 0.2 : 1209                   |
       | 13    | 1697   | 0.04 : 524 / 0.12 : 585 / 0.2 : 588        |

       （信号占用时间在 1ms ~ 125ms 内均匀分布，所有种类的信号都差不多，故省略）

## 2.2 数据集难点
1. 每条数据的点数都非常多（1e6级别），考验数据预处理；
2. 同一条数据中包含的信号数量可能较多（最多8个），且带宽相差很大（最小0.006MHz，最大40.0MHz），信号强度差异也很大，考验数据预处理；
3. 同一条数据内的信号存在时域和频域上的重叠（即干扰），考验检测模型；
4. 经过观察，Class 9 同一类型的不同带宽下的时频图特征不同，即存在不同特征不同模样的信号同属一种类型，考验数据预处理和检测模型；
5. （待补充）

# 3. 总体方案
<div style="text-align: center;">
  <img src="assets/solution/overall-technical-route.drawio.svg">
</div>

# 4. 方案 v1 （基线）

## 4.1 系统框图

<div style="text-align: center;">
  <img src="assets/solution/overall-technical-route.drawio.svg">
</div>

1. **STFT的具体参数配置：**
   1. 模式：固定窗长=1024
   2. 尺度：分贝
   3. 归一化：全局归一化（-140dB ~ 30dB）
   4. 保存图片格式：
      1. 三通道：幅度灰度图（RGB通道均为幅度）
      2. 格式：jpg

## 4.2 实验结果

1. 自制测试脚本，conf=0.001

| Class   | P          | R          | mAP@.50    | mAP@.5-.95 |
| ------- | ---------- | ---------- | ---------- | ---------- |
| 1       | 0.3466     | 0.5364     | 0.3383     | 0.2887     |
| 2       | 0.3754     | 0.3878     | 0.3825     | 0.3241     |
| 3       | 0.6526     | 0.3500     | 0.4167     | 0.3118     |
| 4       | 0.3340     | 0.5781     | 0.5092     | 0.4465     |
| 5       | 0.3498     | 0.5547     | 0.5365     | 0.4571     |
| 6       | 0.7968     | 0.4272     | 0.5446     | 0.4363     |
| 7       | 0.8149     | 0.5223     | 0.6447     | 0.5084     |
| 8       | 0.8133     | 0.5876     | 0.6940     | 0.5653     |
| 9       | 0.6895     | 0.1133     | 0.2392     | 0.1701     |
| 10      | 0.4710     | 0.3924     | 0.3531     | 0.2715     |
| 11      | 0.5102     | 0.4506     | 0.4320     | 0.3618     |
| 12      | 0.7484     | 0.0419     | 0.1453     | 0.0820     |
| 13      | 0.7862     | 0.0160     | 0.0342     | 0.0264     |
| **ALL** | **0.5816** | **0.3853** | **0.4053** | **0.3292** |

1. 自制测试脚本，conf=0.2

| Class   | P          | R          | mAP@.50    | mAP@.5-.95 |
| ------- | ---------- | ---------- | ---------- | ---------- |
| 0       | 0.4792     | 0.4423     | 0.4301     | 0.3973     |
| 1       | 0.3628     | 0.5166     | 0.3433     | 0.3062     |
| 2       | 0.4085     | 0.3946     | 0.4236     | 0.3691     |
| 3       | 0.7000     | 0.3500     | 0.5336     | 0.4426     |
| 4       | 0.3900     | 0.6094     | 0.5419     | 0.4946     |
| 5       | 0.3571     | 0.5469     | 0.5302     | 0.4751     |
| 6       | 0.8434     | 0.4334     | 0.6582     | 0.5546     |
| 7       | 0.8571     | 0.5196     | 0.7153     | 0.6081     |
| 8       | 0.8551     | 0.5934     | 0.7568     | 0.6560     |
| 9       | 0.7547     | 0.1074     | 0.4386     | 0.3375     |
| 10      | 0.5074     | 0.3898     | 0.3678     | 0.3089     |
| 11      | 0.5342     | 0.4382     | 0.4659     | 0.4101     |
| 12      | 0.8750     | 0.0419     | 0.4615     | 0.3892     |
| 13      | 1.0000     | 0.0160     | 0.5080     | 0.4572     |
| **ALL** | **0.6375** | **0.3857** | **0.5125** | **0.4433** |

## 4.3 分析总结

问题：
1. 重叠标签
      对于重叠标签，训练时可以通过微调位置避免被检查，但是在NMS时怎么办？所以考虑DETR。
2. 


# 5. 方案 v2

## 5.0 讨论

### 5.0.1 STFT策略
在STFT模块，当前选择的是固定窗长为 1024 的模式 (STFT_MODE=1) ，所以时频图的频率轴（纵轴）长度始终为 1024 .
但是由数据集介绍可知，样本中存在多种采样率，采样率等于观测带宽，即存在多种观测带宽（5MHz / 20MHz / ... / 80MHz），
如果固定频率轴长度始终为 1024 ，那么相当于把大跨度的多种带宽都映射到相同长度。
虽然可以理解为信号的伸缩变换，可以作为数据增强的一种方法，
但是 80MHz 是 5MHz 的 16 倍，同一个信号在不同分辨率的样本中的样子会相差过大，反而影响学习效果。
所以应该考虑：“对小观测带宽的样本使用小窗，对大观测带宽的样本使用大窗”。
故提出方案：使用固定频率分辨率 (STFT_MODE=3)，即 80MHz/5MHz=16，那么 80MHz的样本使用的窗长度 也是 5MHz的样本使用的窗长度 的16倍。
经过计算，使用固定频率分辨率=20kHz在理论上比较好。（待补充：选择固定频率分辨率=20kHz的计算步骤）
在此情况下，STFT后得到的原图的频率分辨率和时间分辨率都是固定的，也就是说，相同信号在不同采样率中的样本中的样子都是一样的。
但是在ultralytics的训练框架下，均会被缩放到(640,640)，这破坏了“相同信号在不同采样率中的样本中的样子都是一样的”，但同时也可以视为一种数据增强。

固定频率分辨率 (STFT_MODE=3) 情况下还是存在长宽比较大的问题。
为什么这是一个问题呢？
因为训练时需要缩放到正方形，即长边缩放到640，短边相应缩放（≤640）。
假如长宽比较大，那么短边会缩小很多，(640,640)中的有效面积会小很多，即缩小过程中损失的信息更多。
假如长宽比很小（即原图就近似正方形），那么经过imgsz=640的缩放后，可以尽量填满(640,640)，这样有效面积更多，缩放过程中损失的信息更少。
但是如果要实现原图近似正方形，那么就需要在STFT时就破坏 “相同信号在不同采样率中的样本中的样子都是一样的” ，
但是比固定窗还是要好，因为至少遵循了 “对小观测带宽的样本使用小窗，对大观测带宽的样本使用大窗” 。

所以考虑通过实测二者进行决定。

### 5.0.2 尺度策略
（分贝or线性）

### 5.0.3 归一化策略
（全局归一化or样本归一化）
（全局归一化的最小dB和最大dB的选取）

## 5.1 系统框图


## 5.2 实验结果

| num        | STFT_MODE           | USE_DB_SCALE | NORM_TYPE              | mAP50-95 (ALL, conf=0.001) | mAP50-95 (ALL, conf=0.2) |
| ---------- | ------------------- | ------------ | ---------------------- | -------------------------- | ------------------------ |
| v1_base_1  | 1 (NPERSEG=1024)    | True         | GLOBAL (-140dB ~ 30dB) | 0.3292                     | 0.4433                   |
| v1_base_2  | 1 (NPERSEG=1024)    | False        | GLOBAL (-140dB ~ 30dB) | 0.0055                     | /                        |
| v1_base_3  | 1 (NPERSEG=1024)    | True         | SAMPLE                 | 0.3502                     | 0.4522                   |
| v1_base_4  | 1 (NPERSEG=1024)    | False        | SAMPLE                 | 0.3374                     | 0.4578                   |
|            |                     |              |                        |                            |                          |
| v1_base_5  | 2                   | True         | GLOBAL (-140dB ~ 30dB) | 0.5010                     | 0.5490                   |
| v1_base_6  | 2                   | False        | GLOBAL (-140dB ~ 30dB) | /                          | /                        |
| v1_base_7  | 2                   | True         | SAMPLE                 | 0.5013                     | 0.5648                   |
| v1_base_8  | 2                   | False        | SAMPLE                 | 0.5134                     | **0.5811**               |
|            |                     |              |                        |                            |                          |
| v1_base_9  | 3 (FREQ_RES_KHZ=20) | True         | GLOBAL (-140dB ~ 30dB) | 0.4935                     | 0.5652                   |
| v1_base_10 | 3 (FREQ_RES_KHZ=20) | False        | GLOBAL (-140dB ~ 30dB) | 0.0051                     | /                        |
| v1_base_11 | 3 (FREQ_RES_KHZ=20) | True         | SAMPLE                 | 0.4839                     | 0.5512                   |
| v1_base_12 | 3 (FREQ_RES_KHZ=20) | False        | SAMPLE                 | 0.4916                     | 0.5636                   |


# 6. 方案 v3
（切片）

# 7. 方案 v4
（双分支）

## 7.2 实验结果

### large分支

| num        | STFT_MODE        | USE_DB_SCALE | NORM_TYPE              | mAP50-95 (large, ultralytics) |
| ---------- | ---------------- | ------------ | ---------------------- | ----------------------------- |
| v1_large_1 | 1 (NPERSEG=1024) | True         | GLOBAL (-140dB ~ 30dB) |                               |
|            |                  |              |                        |                               |
| v1_large_8 | 2                | False        | SAMPLE                 |                               |

### small分支
（强制 STFT_MODE=3 即 固定分辨率）

| num        | STFT_MODE          | USE_DB_SCALE | NORM_TYPE              | mAP50-95 (small, ultralytics) |
| ---------- | ------------------ | ------------ | ---------------------- | ----------------------------- |
| v1_small_1 | 3 (FREQ_RES_KHZ=5) | True         | GLOBAL (-140dB ~ 30dB) |                               |
| v1_small_2 | 3 (FREQ_RES_KHZ=5) | False        | GLOBAL (-140dB ~ 30dB) |                               |
| v1_small_3 | 3 (FREQ_RES_KHZ=5) | True         | SAMPLE                 |                               |
| v1_small_4 | 3 (FREQ_RES_KHZ=5) | False        | SAMPLE                 |                               |
 