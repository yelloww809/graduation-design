# 1. **背景**
pass


# 2. **数据集分析**

## 2.1 数据集信息

1. **由官方提供的数据集介绍 [data_intro](assets/official-docs/data-intro.md) 可知：**
   1. 数据共7500条；
   2. 采样率可能取值为 5MHz / 20MHz / 30MHz / 40MHz / 50MHz / 80MHz；
   3. 采样时长可能取值为 20ms / 40ms / 60ms / 80ms / 100ms / 150ms；
   4. 一条数据中最少包含1个信号，最多包含8个信号，这些信号可能在时域和频域上存在重叠，也就是说存在信号之间的干扰；

2. **由 [决赛路演视频](https://www.bilibili.com/video/BV1zS2BB4EQ9/?share_source=copy_web&vd_source=0c1479399d156d8020ab4bd08b058c8a) 可知：** 

    | Class | 信号类型 | 工作模式 | 调制方式 | 带宽(MHz)              |
    | ----- | -------- | -------- | -------- | ---------------------- |
    | 0     | WiFi     | HT20     | QPSK     | 20.0                   |
    | 1     | WiFi     | HT20     | 16QAM    | 20.0                   |
    | 2     | WiFi     | HT20     | 64QAM    | 20.0                   |
    | 3     | WiFi     | HT40     | QPSK     | 20.0 / 40.0            |
    | 4     | WiFi     | HT40     | 16QAM    | 40.0                   |
    | 5     | WiFi     | HT40     | 64QAM    | 40.0                   |
    | 6     | BLE      | LE       | GFSK     | 1.0                    |
    | 7     | BLE      | LE       | GFSK     | 2.0                    |
    | 8     | ZigBee   | standard | OQPSK    | 2.0                    |
    | 9     | LoRa     | standard | CSS      | 0.0523 / 0.0625 / 0.25 |
    | 10    | custom   | /        | QPSK     | 0.3 / 0.5 / 10.0       |
    | 11    | custom   | /        | 16QAM    | 1.6 / 7.56 / 10.0      |
    | 12    | custom   | /        | AM       | 0.006 / 0.2            |
    | 13    | custom   | /        | FM       | 0.04 / 0.12 / 0.2      |

3. **通过 python 脚本对数据集进行分析，可知：**
pass

## 2.2 数据集难点
1. 每条数据的点数都非常多（1e6级别），考验数据预处理；
2. 同一条数据中包含的信号数量可能较多（最多8个），且带宽相差很大（最小0.006MHz，最大40.0MHz），信号强度差异也很大，考验数据预处理；
3. 同一条数据内的信号存在时域和频域上的重叠（即干扰），考验检测模型；
4. 经过观察，Class 9 同一类型的不同带宽下的时频图特征不同，即存在不同特征不同模样的信号同属一种类型，考验数据预处理和检测模型；
5. （待补充）



# 3. **总体方案**
<div style="text-align: center;">
  <img src="C:\Users\yellow\Desktop\graduation-design\项目笔记\2-流程图\overall-technical-route.drawio.svg">
</div>

<!-- ============================================================================== -->
<!-- ============================================================================== -->

# 4. **方案 v1 （基线 : base）**

## 4.1 系统框图

<div style="text-align: center;">
  <img src="C:\Users\yellow\Desktop\graduation-design\项目笔记\2-流程图\solution-v1.drawio.svg">
</div>

**STFT的具体参数配置：**
1. 模式：固定窗长=1024
2. 尺度：分贝
3. 归一化：全局归一化（-140dB ~ 30dB）
4. 保存图片格式：
   1. 三通道：幅度灰度图（RGB通道均为幅度）
   2. 格式：jpg

## 4.2 实验结果、发现的问题
### 4.2.1 实验结果
（结果）

### 4.2.2 发现的问题
| 编号 | 问题                                        |
| ---- | ------------------------------------------- |
| 1    | 所有类别的信号的识别精度都达不到要求（0.6） |
| 2    | 窄带信号的检测率尤其低                      |
| 3    | 混淆                                        |
| 4    | 存在两个完全一模一样的信号                  | 

❌错误思路：
两个完全相同的信号，标签相同，ultralytics训练时会自动去重。
对于重叠标签，训练时可以通过微调位置避免被检查，但是在NMS时怎么办？所以考虑DETR。
🗣️解释：这是 信号处理/通信领域 与 计算机视觉领域 的合理性判断区别，在信号领域合理，在计算机视觉领域不合理，不是能通过换模型解决的。

## 4.3 下一版针对：问题1

分析认为，整体识别精度不达标应该是数据集预处理的问题。

### STFT策略：
在STFT模块，当前选择的是固定窗长为 1024 的模式 (STFT_MODE=1) ，所以时频图的频率轴（纵轴）长度始终为 1024 .
但是由数据集介绍可知，样本中存在多种采样率，采样率等于观测带宽，即存在多种观测带宽（5MHz / 20MHz / ... / 80MHz），
如果固定频率轴长度始终为 1024 ，那么相当于把大跨度的多种带宽都映射到相同长度。
虽然可以理解为信号的伸缩变换，可以作为数据增强的一种方法，
但是 80MHz 是 5MHz 的 16 倍，同一个信号在不同分辨率的样本中的样子会相差过大，反而影响学习效果。
所以应该考虑：“对小观测带宽的样本使用小窗，对大观测带宽的样本使用大窗”。

**方案1：使用固定频率分辨率 (STFT_MODE=3)**
即 80MHz/5MHz=16，那么 80MHz的样本使用的窗长度 也是 5MHz的样本使用的窗长度 的16倍。
经过计算（待补充：选择固定频率分辨率=20kHz的计算步骤），使用固定频率分辨率=20kHz在理论上比较好。
在此情况下，STFT后得到的原图的频率分辨率和时间分辨率都是固定的，也就是说，相同信号在不同采样率中的样本中的样子都是一样的。
但是在ultralytics的训练框架下，均会被缩放到(640,640)，这破坏了“相同信号在不同采样率中的样本中的样子都是一样的”，但同时也可以视为一种数据增强。

**方案2：原图近似正方形 (STFT_MODE=2)**
固定频率分辨率 (STFT_MODE=3) 情况下还是存在长宽比较大的问题。
为什么这是一个问题呢？
因为训练时需要缩放到正方形，即长边缩放到640，短边相应缩放（≤640）。
假如长宽比较大，那么短边会缩小很多，(640,640)中的有效面积会小很多，即缩小过程中损失的信息更多。
假如长宽比很小（即原图就近似正方形），那么经过imgsz=640的缩放后，可以尽量填满(640,640)，这样有效面积更多，缩放过程中损失的信息更少。
但是如果要实现原图近似正方形，那么就需要在STFT时就破坏 “相同信号在不同采样率中的样本中的样子都是一样的” ，
但是比固定窗还是要好，因为至少遵循了 “对小观测带宽的样本使用小窗，对大观测带宽的样本使用大窗” 。

### 尺度策略：
（分贝or线性）

###  归一化策略
（全局归一化or样本归一化）
（全局归一化的最小dB和最大dB的选取）

<!-- ============================================================================== -->
<!-- ============================================================================== -->

# 5. **方案 v2（base）**
## 5.1 系统框图
图同4.1

| STFT参数项     | 配置                                                           |
| -------------- | -------------------------------------------------------------- |
| STFT模式       | 1. 固定频率分辨率(STFT_MODE=2) <br> 2. 近似正方形(STFT_MODE=3) |
| 坐标尺度       | 1. 分贝尺度坐标 <br> 2. 线性尺度坐标                           |
| 归一化方式     | 1. 全局归一化(-140dB ~ 30dB) <br> 2. 样本归一化                |
| 时频图保存格式 | 幅度灰度图(RGB通道均为幅度) + jpg文件格式                      |

## 5.2 实验结果、对原本问题的解决情况、是否有新问题
### 5.2.1 实验结果
（结果）

### 5.2.2 对现有问题的解决情况
1. 所有种类的信号的检测精度都不达标：得到较好解决；
2. 窄带信号（Class 9 / 12 / 13，Class 10 受影响）的检测精度尤其低：未很好解决；
3. 信号混淆：未很好解决；
4. 信号的完全碰撞：未解决；

### 5.2.3 是否有新问题
（没有发现新的问题）

## 5.3 下一版针对：问题2
从数据看：Class 9 / 12 / 13 窄带信号的P很高，但是R很低，即能框住，但是可能真实框比预测框小很多，导致整体的mAP较低；
推论：Class 10 也包括窄带，应该也受影响。

(pass)

<!-- ============================================================================== -->
<!-- ============================================================================== -->

# 6. 方案 v3（切片方案 : slice）
## 6.1 系统框图

## 6.2 实验结果、对原本问题的解决情况、是否有新问题
### 6.2.1 实验结果
（结果）

### 6.2.2 对现有问题的解决情况

| 问题                                                                 | 解决情况               |
| -------------------------------------------------------------------- | ---------------------- |
| 所有种类的信号的检测精度都不达标                                     | / （方案v2已较好解决） |
| 窄带信号的检测精度尤其低 <br> （Class 9 / 12 / 13，Class 10 受影响） | ==未很好解决==         |
| 信号混淆                                                             | 未解决                 |
| 完全相同的信号的碰撞                                                 | 未解决                 |

### 6.2.3 是否发现新问题
（没有发现新的问题）

## 6.3 下一版针对：问题2

<!-- ============================================================================== -->
<!-- ============================================================================== -->

# 7. 方案 v4（双分支 : dual）
## 7.1 系统框图

## 7.2 实验结果、对原本问题的解决情况、是否有新问题
### 7.2.1 实验结果
（结果）

### 7.2.2 对现有问题的解决情况
| 问题                                                                 | 解决情况               |
| -------------------------------------------------------------------- | ---------------------- |
| 所有种类的信号的检测精度都不达标                                     | / （方案v2已较好解决） |
| 窄带信号的检测精度尤其低 <br> （Class 9 / 12 / 13，Class 10 受影响） | ==得到较好解决==       |
| 信号混淆                                                             | 未解决                 |
| 完全相同的信号的碰撞                                                 | 未解决                 |

### 7.2.3 是否发现新问题
（没有发现新的问题）

## 7.3 下一版针对：问题3
混淆：
1. Class 0/1/2（均为 WiFi HT20 工作模式，调制方式分别为 QPSK / 16QAM / 64QAM）；
2. Class 3/4/5（均为 WiFi HT40 工作模式，调制方式分别为 QPSK / 16QAM / 64QAM）；
3. Class 10/11（均为自定义的信号，调制方式分别为 QPSK / 16QAM）；

分析：
1. 因为是同类信号，所以使用的成型滤波器是相同的，所以信号在频域上的形状是相同的（即沿时间轴切片，每一条的形状都大致相同）
2. QPSK / 16QAM / 64QAM 的区别：
   1. QPSK：4个星座点（1种幅度，4种相位）；
   2. 16QAM：16个星座点（3种幅度，12种相位）；
   3. 64QAM：64个星座点（9种幅度，28种相位）；

   但是在预处理过程中：
   1. 相位被直接抹去，就算不抹去，也没有同步；
   2. 如果要看清幅度，（标准规定子载波间隔为312.5kHz）那么时间分辨率要小于3.2us，那么频率分辨率就会很低。要想时频完美对齐每一个符号是不可能的，通常会被平均化，那么就不能通过几种幅度来确定调制类型；

<!-- ============================================================================== -->
<!-- ============================================================================== -->

# 8. 方案 v5（双分支+RGB : dual）
## 8.1 系统框图
系统框图同7.1

| STFT参数项     | 配置                                     |
| -------------- | ---------------------------------------- |
| STFT模式       | 固定频率分辨率(STFT_MODE=2)              |
| 坐标尺度       | 线性尺度坐标                             |
| 归一化方式     | 样本归一化                               |
| 时频图保存格式 | ==三通道(幅度+正弦+余弦)== + jpg文件格式 |

## 8.2 实验结果、对原本问题的解决情况、是否有新问题
### 8.2.1 实验结果

### 8.2.2 对原本问题的解决情况

### 8.2.3 是否有新问题
（没有发现新问题）

## 8.3 下一版针对：问题3
上一版中忽略的问题：没有同步！


<!-- ============================================================================== -->
<!-- ============================================================================== -->

# 9. 方案 v6（双分支+调制识别 : twostage）
## 9.1 系统框图
（框图）

**large 分支：**
| STFT参数项     | 配置                                     |
| -------------- | ---------------------------------------- |
| STFT模式       | 固定频率分辨率(STFT_MODE=2)              |
| 坐标尺度       | 线性尺度坐标                             |
| 归一化方式     | 样本归一化                               |
| 时频图保存格式 | ==三通道(幅度+正弦+余弦)== + jpg文件格式 |

**small 分支：**
| STFT参数项     | 配置                                     |
| -------------- | ---------------------------------------- |
| STFT模式       | 固定频率分辨率(STFT_MODE=2)              |
| 坐标尺度       | 线性尺度坐标                             |
| 归一化方式     | 样本归一化                               |
| 时频图保存格式 | ==三通道(幅度+正弦+余弦)== + jpg文件格式 |

## 9.2 实验结果、对原本问题的解决情况、是否有新问题
### 9.2.1 实验结果

### 9.2.2 对原本问题的解决情况

### 9.2.3 是否有新问题

## 9.3 下一版针对：问题4


# 随手
**（突然想到，应该在同一数据集上多种切分train/val/test，但是要独立训练，可以证明不是选择test数据让指标变高。）**